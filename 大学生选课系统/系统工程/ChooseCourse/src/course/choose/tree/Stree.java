package course.choose.tree;

import java.awt.Component;
import java.awt.Dimension;
import java.awt.Event;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.swing.ImageIcon;
import javax.swing.JDialog;
import javax.swing.JMenuItem;
import javax.swing.JOptionPane;
import javax.swing.JPopupMenu;
import javax.swing.JScrollPane;
import javax.swing.JTree;
import javax.swing.tree.DefaultMutableTreeNode;
import javax.swing.tree.DefaultTreeCellRenderer;
import javax.swing.tree.DefaultTreeModel;
import javax.swing.tree.TreeSelectionModel;

import course.choose.dao.Dao;
import course.choose.dialog.ClassDialog;
import course.choose.dialog.SDialog;



public class Stree {
	JTree tree;
	ResultSet rs1;
	ResultSet rs2;
	public DefaultTreeModel defaultmodel;
	public DefaultMutableTreeNode rootNode;
	private JPopupMenu popupMenu;
	final JMenuItem menuItem1 = new JMenuItem();
	final JMenuItem menuItem2 = new JMenuItem();
	public JScrollPane jp;	

	public Stree() {
		
		DefaultMutableTreeNode defaultmodelNode = getStudentTree();
		defaultmodel = new DefaultTreeModel(defaultmodelNode);
		tree = new JTree(defaultmodel);
		tree.getSelectionModel().setSelectionMode(TreeSelectionModel.SINGLE_TREE_SELECTION); //某一时刻只有一个节点被选中
		//tree.putClientProperty("Jtree.lineStyle","None");
		 ImageIcon leafIcon = new ImageIcon("src/image/student.jpg");
		 if (leafIcon != null) {
		     DefaultTreeCellRenderer renderer = new DefaultTreeCellRenderer();
		     renderer.setLeafIcon(leafIcon);
		     tree.setCellRenderer(renderer);
		 }//设置节点图标

		jp = new JScrollPane(tree);		
		shows();
	}
/*添加树节点
 * 
 */
	public void add() {
		DefaultMutableTreeNode node = getSelectedNode();
		//判断是否选中一个节点
		if (node == null) {
			JOptionPane.showMessageDialog(null, "请先选择一个区域", "Error",
					JOptionPane.ERROR_MESSAGE);
			return;
		}
		String snode = node.toString();//获取所选节点名称
		int iclassname = 0;
		if (node.isRoot()) {			
			ClassDialog cg = new ClassDialog(this);
		} else  { 
			try {
				iclassname = Integer.parseInt(snode);
				}catch(NumberFormatException e) {
					JOptionPane.showMessageDialog(null, "叶节点不允许插入");
					return;
				}		
			SDialog dia = new SDialog(this,snode);
			dia.setVisible(true);
			dia.setLocationRelativeTo(null);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
		}

	}
/*获得选中的节点
 * 
 */
	public DefaultMutableTreeNode getSelectedNode() {
		if (tree != null)
			return (DefaultMutableTreeNode) tree.getLastSelectedPathComponent();
		else
			return null;
	}
	/*生成树
	 * 
	 */
	private DefaultMutableTreeNode getStudentTree() {
		DefaultMutableTreeNode rootNode = new DefaultMutableTreeNode("专业班级");
		String sql = "select SClassNo from tb_SpeClass";

		rs1 = Dao.executeQuery(sql);
		String s;
		try {
			while (rs1.next()) {
				s = rs1.getString("SClassNo");
				String sql2 = "select SName,SNo from tb_student where SClassNo = '"
						+ s + "'";
				DefaultMutableTreeNode ban1 = new DefaultMutableTreeNode(s);
				rootNode.add(ban1);
				rs2 = Dao.executeQuery(sql2);
				while (rs2.next()) {
					String names = rs2.getString("SName");
					String sno = rs2.getString("SNo");
					StudentLeafNode snoe = new StudentLeafNode(sno, names);
					ban1.add(new DefaultMutableTreeNode(snoe));
				}
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return rootNode;//返回根节点

	}
/* 添加叶节点后更新树
 * 
 */
	public void update(String names) {		
		DefaultMutableTreeNode insertparent = getSelectedNode();		
		defaultmodel.insertNodeInto(new DefaultMutableTreeNode(names),
				insertparent, insertparent.getChildCount());
		
		jp.setVisible(true);
		
	}

	/*
	 * 完成右击弹出式菜单动作
	 */
	public void shows() {
		if (tree != null) {
			tree.addMouseListener(new MouseAdapter() {
				public void mouseClicked(MouseEvent e) {
					if (e.getModifiers() == Event.META_MASK) {
						addPopup(jp, popupMenu);
						popupMenu.show(jp, e.getX(), e.getY());
					}
				}
			});

			popupMenu = new JPopupMenu();
			final JMenuItem menuItem1 = new JMenuItem();
			final JMenuItem menuItem2 = new JMenuItem();
			menuItem1.addActionListener(new ActionListener() {//添加 添加响应
				public void actionPerformed(ActionEvent e) {
					add();
				}
			});
			menuItem2.addActionListener(new ActionListener() {//添加 删除响应
				public void actionPerformed(ActionEvent e) {
					DefaultMutableTreeNode node = (DefaultMutableTreeNode) tree
							.getLastSelectedPathComponent();
					if((node.toString()).equals("专业班级")) {
						JOptionPane.showMessageDialog(null, "该项不能删除！");
						return;
					}else {
					DefaultTreeModel model = (DefaultTreeModel) tree.getModel();
					model.removeNodeFromParent(node);
					remove(node);
					}
				}
			});
			menuItem1.setText("添加");
			menuItem2.setText("删除");
			popupMenu.add(menuItem1);
			popupMenu.add(menuItem2);
		}
	}
	/*
	 * 删除节点
	 */
		public void remove(DefaultMutableTreeNode node) {	
			String snode = node.toString();	
			try {
				int iclassno = Integer.parseInt(snode);
				String sql = "delete tb_SpeClass where SClassNo = "+iclassno;
				Dao.executeUpdate(sql);
			}catch(NumberFormatException e) {
				Object nodeInfo = node.getUserObject();//获得节点关联的数据
				StudentLeafNode snoe = (StudentLeafNode)nodeInfo;
				String sno = snoe.getNo();
				String sql = "delete tb_student where sno = "+sno;
				Dao.executeUpdate(sql);
			}
		  
			
		}
	/*
	 * 构建弹出式菜单的具体位置
	 */
	private static void addPopup(Component component, final JPopupMenu popup) {
		component.addMouseListener(new MouseAdapter() {
			public void mousePressed(MouseEvent e) {
				if (e.isPopupTrigger())
					showMenu(e);
			}

			public void mouseReleased(MouseEvent e) {
				if (e.isPopupTrigger())
					showMenu(e);
			}

			private void showMenu(MouseEvent e) {
				popup.show(e.getComponent(), e.getX(), e.getY());
			}
		});
	}

}
